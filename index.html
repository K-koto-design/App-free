<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
}

.hidden { display: none; }

/* INSTALL SCREEN */
#install {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

#install img {
  width: 120px;
  border-radius: 26px;
}

button {
  background: #007aff;
  color: white;
  border: none;
  padding: 14px 32px;
  border-radius: 22px;
  font-size: 16px;
  cursor: pointer;
}

#apk {
  display: none;
  margin-top: 15px;
  color: green;
  text-decoration: none;
}

/* STORE */
#store {
  padding: 20px;
}

.header {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 20px;
}

.app {
  background: white;
  border-radius: 20px;
  padding: 15px;
  display: flex;
  margin-bottom: 15px;
}

.app img {
  width: 80px;
  height: 80px;
  border-radius: 18px;
  margin-right: 15px;
}
</style>
</head>

<body>

<!-- INSTALL SCREEN -->
<div id="install">
  <img src="icon.png">
  <h2>Установите приложение</h2>
  <p id="platformText"></p>
  <button id="installBtn">Установить</button>
  <a id="apk" href="app.apk" download>Скачать APK</a>
</div>

<!-- STORE -->
<div id="store" class="hidden">
  <div class="header">Приложения</div>
  <div id="apps"></div>
</div>

<script>
/* ================= НАСТРОЙКИ ================= */
const APPS = [
  {
    name: "My App",
    description: "Описание приложения",
    icon: "icon.png",
    url: "https://your-pwa-site.com"
  },
  {
    name: "Second App",
    description: "Второе приложение",
    icon: "icon.png",
    url: "https://example.com"
  }
];

/* ================= PLATFORM ================= */
const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
const isAndroid = /android/i.test(navigator.userAgent);

const installScreen = document.getElementById('install');
const store = document.getElementById('store');
const appsContainer = document.getElementById('apps');
const installBtn = document.getElementById('installBtn');
const apk = document.getElementById('apk');
const platformText = document.getElementById('platformText');

let deferredPrompt = null;

/* ================= PLATFORM TEXT ================= */
if (isIOS) {
  platformText.innerHTML = 'Нажмите <b>Поделиться</b> → <b>На экран «Домой»</b>';
  installBtn.style.display = 'none';
}

if (isAndroid) {
  platformText.innerText = 'Установите PWA или скачайте APK';
  apk.style.display = 'block';
}

/* ================= INSTALL PROMPT ================= */
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
});

installBtn.onclick = async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
};

/* ================= CHECK IF PWA ================= */
function checkIfInstalled() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                       || window.navigator.standalone === true;

  // сохраняем флаг в localStorage
  if (isStandalone) localStorage.setItem('pwaInstalled', 'true');

  // показываем магазин, если standalone или уже установлен ранее
  if (isStandalone || localStorage.getItem('pwaInstalled') === 'true') {
    installScreen.classList.add('hidden');
    store.classList.remove('hidden');
    renderApps();
  } else {
    installScreen.classList.remove('hidden');
    store.classList.add('hidden');
  }
}

/* ================= RENDER APPS ================= */
function renderApps() {
  appsContainer.innerHTML = '';
  APPS.forEach(app => {
    const div = document.createElement('div');
    div.className = 'app';
    div.innerHTML = `
      <img src="${app.icon}">
      <div>
        <h3>${app.name}</h3>
        <p>${app.description}</p>
        <button onclick="openApp('${app.url}')">Открыть</button>
      </div>
    `;
    appsContainer.appendChild(div);
  });
}

function openApp(url) {
  window.location.href = url;
}

/* ================= EVENTS ================= */
window.addEventListener('load', checkIfInstalled);
window.addEventListener('appinstalled', checkIfInstalled);

/* ================= SERVICE WORKER ================= */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log('Service Worker зарегистрирован'))
    .catch(err => console.log('Ошибка SW:', err));
}
</script>

</body>
</html>
